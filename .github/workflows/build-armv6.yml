name: Build librespot (armv6)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build-armv6:
    name: Build armv6 binary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Clone librespot repository
        run: |
          git clone --depth 1 https://github.com/librespot-org/librespot.git /tmp/librespot

      - name: Install Rust and cross-compile tools
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add arm-unknown-linux-gnueabihf
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libasound2-dev \
            libpulse-dev \
            libavahi-compat-libdnssd-dev \
            pkg-config \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            libssl-dev

      - name: Build librespot for armv6
        run: |
          cd /tmp/librespot
          source $HOME/.cargo/env
          export CC_arm_unknown_linux_gnueabihf=arm-linux-gnueabihf-gcc
          export AR_arm_unknown_linux_gnueabihf=arm-linux-gnueabihf-ar
          export PKG_CONFIG_PATH=/usr/arm-linux-gnueabihf/lib/pkgconfig
          mkdir -p .cargo
          echo "[target.arm-unknown-linux-gnueabihf]" > .cargo/config.toml
          echo "linker = \"arm-linux-gnueabihf-gcc\"" >> .cargo/config.toml
          echo "ar = \"arm-linux-gnueabihf-ar\"" >> .cargo/config.toml
          cargo build --release --target arm-unknown-linux-gnueabihf --no-default-features --features "native-tls,pulseaudio-backend,with-avahi"
          cp target/arm-unknown-linux-gnueabihf/release/librespot ${{ github.workspace }}/librespot

      - name: Package .deb for Debian Bullseye (armhf)
        run: |
          set -e
          mkdir -p package/DEBIAN package/usr/local/bin
          cp ${{ github.workspace }}/librespot package/usr/local/bin/librespot
          chmod 755 package/usr/local/bin/librespot
          VERSION=$(date +%Y%m%d)
          printf '%s\n' \
            "Package: librespot" \
            "Version: ${VERSION}" \
            "Section: sound" \
            "Priority: optional" \
            "Architecture: armhf" \
            "Maintainer: RaspiStreamer <noreply@example.com>" \
            "Depends: libc6 (>= 2.28), libasound2, libpulse0, libavahi-compat-libdnssd0" \
            "Description: librespot headless Spotify client (built for Raspberry Pi Zero W / armv6)" \
            > package/DEBIAN/control
          dpkg-deb --build package librespot_${VERSION}_armhf.deb

      - name: Upload artifact (.deb)
        uses: actions/upload-artifact@v4
        with:
          name: librespot-armv6-deb
          path: ./librespot_*_armhf.deb