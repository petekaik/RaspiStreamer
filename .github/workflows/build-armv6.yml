name: Build librespot (armv6)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build-armv6:
    name: Build armv6 binary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Clone librespot repository
        run: |
          git clone --depth 1 https://github.com/librespot-org/librespot.git /tmp/librespot

      - name: Build Docker image for cross-compilation
        run: |
          docker build -t librespot:armv6-builder -f ${{ github.workspace }}/.github/workflows/Dockerfile.armv6 /tmp/librespot

      - name: Extract binary from image
        run: |
          docker run --rm -v ${{ github.workspace }}:/output librespot:armv6-builder bash -c 'cp /workspace/target/arm-unknown-linux-gnueabihf/release/librespot /output/librespot'

      - name: Package .deb for Debian Bullseye (armhf)
        run: |
          set -e
          mkdir -p package/DEBIAN package/usr/local/bin
          cp ./librespot package/usr/local/bin/librespot
          chmod 755 package/usr/local/bin/librespot
          VERSION=$(date +%Y%m%d)
          printf '%s\n' \
            "Package: librespot" \
            "Version: ${VERSION}" \
            "Section: sound" \
            "Priority: optional" \
            "Architecture: armhf" \
            "Maintainer: RaspiStreamer <noreply@example.com>" \
            "Depends: libc6 (>= 2.28), libasound2, libpulse0, libavahi-compat-libdnssd0" \
            "Description: librespot headless Spotify client (built for Raspberry Pi Zero W / armv6)" \
            > package/DEBIAN/control
          dpkg-deb --build package librespot_${VERSION}_armhf.deb

      - name: Upload artifact (.deb)
        uses: actions/upload-artifact@v4
        with:
          name: librespot-armv6-deb
          path: ./librespot_*_armhf.deb