name: Build librespot (armv6)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build-armv6:
    name: Build armv6 binary
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Clone librespot repository
        run: |
          git clone --depth 1 https://github.com/librespot-org/librespot.git /tmp/librespot

      - name: Build image for linux/arm/v6
        run: |
          docker buildx build --platform linux/arm/v6 -t librespot:armv6 --output type=docker,dest=/tmp/librespot-image.tar -f ${{ github.workspace }}/.github/workflows/Dockerfile.armv6 /tmp/librespot

      - name: Load image from tar
        run: |
          docker load --input /tmp/librespot-image.tar

      - name: Create container from image
        run: |
          docker create --platform linux/arm/v6 --name extract_container librespot:armv6 || docker create --name extract_container librespot:armv6

      - name: Copy built binary out
        run: |
          docker cp extract_container:/workspace/target/arm-unknown-linux-gnueabihf/release/librespot ./librespot || true
          docker rm extract_container || true

      - name: Package .deb for Debian Bullseye (armhf)
        run: |
          set -e
          mkdir -p package/DEBIAN package/usr/local/bin
          cp ./librespot package/usr/local/bin/librespot
          chmod 755 package/usr/local/bin/librespot
          VERSION=$(date +%Y%m%d)
          printf '%s\n' \
            "Package: librespot" \
            "Version: ${VERSION}" \
            "Section: sound" \
            "Priority: optional" \
            "Architecture: armhf" \
            "Maintainer: RaspiStreamer <noreply@example.com>" \
            "Depends: libc6 (>= 2.28), libasound2, libpulse0, libavahi-compat-libdnssd0" \
            "Description: librespot headless Spotify client (built for Raspberry Pi Zero W / armv6)" \
            > package/DEBIAN/control
          dpkg-deb --build package librespot_${VERSION}_armhf.deb

      - name: Upload artifact (.deb)
        uses: actions/upload-artifact@v4
        with:
          name: librespot-armv6-deb
          path: ./librespot_*_armhf.deb