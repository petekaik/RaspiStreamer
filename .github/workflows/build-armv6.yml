name: Build librespot (armv6)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build-armv6:
    name: Build armv6 binary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Clone librespot repository
        run: |
          git clone --depth 1 https://github.com/librespot-org/librespot.git /tmp/librespot

      - name: Install Rust and cross-compile tools
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add arm-unknown-linux-gnueabihf

          # Add armhf architecture and configure apt to use ports.ubuntu.com for armhf packages
          CODENAME=$(lsb_release -cs)
          sudo dpkg --add-architecture armhf
          sudo sh -c "echo 'deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports ${CODENAME} main universe' > /etc/apt/sources.list.d/armhf-ports.list"
          sudo sh -c "echo 'deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports ${CODENAME}-updates main universe' >> /etc/apt/sources.list.d/armhf-ports.list"
          sudo sh -c "echo 'deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports ${CODENAME}-security main universe' >> /etc/apt/sources.list.d/armhf-ports.list"

          sudo apt-get update

          # Install host toolchain and target dev packages from ports
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            ca-certificates \
            libssl-dev \
            libssl-dev:armhf \
            libasound2-dev:armhf \
            libpulse-dev:armhf \
            libavahi-compat-libdnssd-dev:armhf

      - name: Build librespot for armv6
        run: |
          cd /tmp/librespot
          source $HOME/.cargo/env
          export CC_arm_unknown_linux_gnueabihf=arm-linux-gnueabihf-gcc
          export AR_arm_unknown_linux_gnueabihf=arm-linux-gnueabihf-ar
          # Ensure pkg-config finds ARMhf .pc files and allow cross pkg-config
          export PKG_CONFIG_ALLOW_CROSS=1
          export PKG_CONFIG_LIBDIR=/usr/arm-linux-gnueabihf/lib/pkgconfig
          export PKG_CONFIG_PATH=/usr/arm-linux-gnueabihf/lib/pkgconfig
          # Help openssl-sys find the cross-compiled OpenSSL
          export OPENSSL_DIR=/usr/arm-linux-gnueabihf
          export OPENSSL_LIB_DIR=/usr/arm-linux-gnueabihf/lib
          export OPENSSL_INCLUDE_DIR=/usr/arm-linux-gnueabihf/include
          mkdir -p .cargo
          echo "[target.arm-unknown-linux-gnueabihf]" > .cargo/config.toml
          echo "linker = \"arm-linux-gnueabihf-gcc\"" >> .cargo/config.toml
          echo "ar = \"arm-linux-gnueabihf-ar\"" >> .cargo/config.toml
          cargo build --release --target arm-unknown-linux-gnueabihf --no-default-features --features "native-tls,pulseaudio-backend,with-avahi"
          cp target/arm-unknown-linux-gnueabihf/release/librespot ${{ github.workspace }}/librespot

      - name: Package .deb for Debian Bullseye (armhf)
        run: |
          set -e
          mkdir -p package/DEBIAN package/usr/local/bin
          cp ${{ github.workspace }}/librespot package/usr/local/bin/librespot
          chmod 755 package/usr/local/bin/librespot
          VERSION=$(date +%Y%m%d)
          printf '%s\n' \
            "Package: librespot" \
            "Version: ${VERSION}" \
            "Section: sound" \
            "Priority: optional" \
            "Architecture: armhf" \
            "Maintainer: RaspiStreamer <noreply@example.com>" \
            "Depends: libc6 (>= 2.28), libasound2, libpulse0, libavahi-compat-libdnssd0" \
            "Description: librespot headless Spotify client (built for Raspberry Pi Zero W / armv6)" \
            > package/DEBIAN/control
          dpkg-deb --build package librespot_${VERSION}_armhf.deb

      - name: Upload artifact (.deb)
        uses: actions/upload-artifact@v4
        with:
          name: librespot-armv6-deb
          path: ./librespot_*_armhf.deb